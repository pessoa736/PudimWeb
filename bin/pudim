#!/usr/bin/env lua
---@diagnostic disable
--[[
    PudimWeb CLI
    ============
    
    Ferramenta de linha de comando para criar e gerenciar projetos PudimWeb.
    
    INSTALAÃ‡ÃƒO:
    -----------
    Via LuaRocks (automaticamente instalado com pudimweb):
        luarocks install pudimweb
    
    Manual:
        chmod +x bin/pudim
        sudo ln -s $(pwd)/bin/pudim /usr/local/bin/pudim
    
    COMANDOS:
    ---------
    pudim new <nome>    Cria um novo projeto com estrutura Next.js style
                        - app/pages/     â†’ Rotas automÃ¡ticas
                        - app/api/       â†’ API Routes
                        - app/components â†’ Componentes
                        - app/public/    â†’ Arquivos estÃ¡ticos
    
    pudim serve [porta] Inicia o servidor de desenvolvimento
                        Porta padrÃ£o: 3000
    
    pudim help          Mostra esta mensagem de ajuda
    
    EXEMPLOS:
    ---------
    pudim new meu-blog
    cd meu-blog
    ./install.sh
    lua server.lua
    
    @script pudim
    @author pessoa736
    @license MIT
--]]

local CLI = {}

local colors = {
    reset = "\27[0m",
    bold = "\27[1m",
    red = "\27[31m",
    green = "\27[32m",
    yellow = "\27[33m",
    cyan = "\27[36m",
}

local function colorize(text, color)
    return (colors[color] or "") .. text .. colors.reset
end

local function print_logo()
    print(colorize([[

    â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
    â•‘           ğŸ® PudimWeb CLI             â•‘
    â•‘     Framework Web para Lua 5.4        â•‘
    â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    ]], "yellow"))
end

local function print_success(msg) print(colorize("  âœ“ ", "green") .. msg) end
local function print_info(msg) print(colorize("  â†’ ", "cyan") .. msg) end
local function print_error(msg) print(colorize("  âœ— ", "red") .. msg) end

local function mkdir(path)
    os.execute('mkdir -p "' .. path .. '"')
end

local function write_file(path, content)
    local file = io.open(path, "w")
    if file then
        file:write(content)
        file:close()
        return true
    end
    return false
end

-- Templates
local function tpl_server(name)
    return '--[[\n    ' .. name .. ' - Servidor PudimWeb (Next.js style)\n    Execute com: lua server.lua\n]]\n\n' ..
        'package.path = table.concat({\n' ..
        '    "./?.lua",\n' ..
        '    "./?/init.lua",\n' ..
        '    "./app/?.lua",\n' ..
        '    "./app/?/init.lua",\n' ..
        '    "./lua_modules/share/lua/5.4/?.lua",\n' ..
        '    "./lua_modules/share/lua/5.4/?/init.lua",\n' ..
        '}, ";") .. ";" .. package.path\n\n' ..
        'package.cpath = table.concat({\n' ..
        '    "./lua_modules/lib/lua/5.4/?.so",\n' ..
        '}, ";") .. ";" .. package.cpath\n\n' ..
        'pcall(require, "luarocks.loader")\n' ..
        'require("DaviLuaXML")\n\n' ..
        'local pudim = require("PudimWeb")\n\n' ..
        '-- ExpÃµe globais para arquivos .lx\n' ..
        'pudim.expose()\n\n' ..
        '-- Inicia com roteamento automÃ¡tico (estilo Next.js)\n' ..
        'pudim.start({\n' ..
        '    port = 3000,\n' ..
        '    pagesDir = "./app/pages",\n' ..
        '    publicDir = "./app/public",\n' ..
        '    apiDir = "./app/api",\n' ..
        '})\n'
end

local function tpl_index(name)
    return '-- app/pages/index.lx\n' ..
        '-- Rota: /\n\n' ..
        '-- Aliases para tags HTML (DaviLuaXML nÃ£o suporta "." em tags)\n' ..
        'local Html, Head, Body = html.html, html.head, html.body\n' ..
        'local Meta, Title, Link = html.meta, html.title, html.link\n' ..
        'local Div, H1, P, Nav, A = html.div, html.h1, html.p, html.nav, html.a\n\n' ..
        'local function Home()\n' ..
        '    return html.doctype .. <Html lang="pt-BR">\n' ..
        '        <Head>\n' ..
        '            <Meta charset="utf-8" />\n' ..
        '            <Meta name="viewport" content="width=device-width, initial-scale=1" />\n' ..
        '            <Title>' .. name .. '</Title>\n' ..
        '            <Link rel="stylesheet" href="/css/style.css" />\n' ..
        '        </Head>\n' ..
        '        <Body>\n' ..
        '            <Div class="container">\n' ..
        '                <H1>ğŸ® ' .. name .. '</H1>\n' ..
        '                <P>Seu projeto PudimWeb estÃ¡ rodando!</P>\n' ..
        '                <Nav>\n' ..
        '                    <A href="/">Home</A>\n' ..
        '                    <A href="/about">Sobre</A>\n' ..
        '                </Nav>\n' ..
        '            </Div>\n' ..
        '        </Body>\n' ..
        '    </Html>\n' ..
        'end\n\n' ..
        'return Home\n'
end

local function tpl_about(name)
    return '-- app/pages/about.lx\n' ..
        '-- Rota: /about\n\n' ..
        '-- Aliases para tags HTML\n' ..
        'local Html, Head, Body = html.html, html.head, html.body\n' ..
        'local Meta, Title, Link = html.meta, html.title, html.link\n' ..
        'local Div, H1, P, A = html.div, html.h1, html.p, html.a\n\n' ..
        'local function About()\n' ..
        '    return html.doctype .. <Html lang="pt-BR">\n' ..
        '        <Head>\n' ..
        '            <Meta charset="utf-8" />\n' ..
        '            <Title>Sobre - ' .. name .. '</Title>\n' ..
        '            <Link rel="stylesheet" href="/css/style.css" />\n' ..
        '        </Head>\n' ..
        '        <Body>\n' ..
        '            <Div class="container">\n' ..
        '                <H1>Sobre</H1>\n' ..
        '                <P>PÃ¡gina sobre criada automaticamente.</P>\n' ..
        '                <A href="/">Voltar</A>\n' ..
        '            </Div>\n' ..
        '        </Body>\n' ..
        '    </Html>\n' ..
        'end\n\n' ..
        'return About\n'
end

local function tpl_api_hello()
    return '-- app/api/hello.lua\n' ..
        '-- Rota: /api/hello\n\n' ..
        'return {\n' ..
        '    GET = function(req, res)\n' ..
        '        res.json({\n' ..
        '            message = "Hello from PudimWeb API!",\n' ..
        '            timestamp = os.date(),\n' ..
        '        })\n' ..
        '    end,\n' ..
        '    \n' ..
        '    POST = function(req, res)\n' ..
        '        res.json({\n' ..
        '            message = "POST recebido!",\n' ..
        '            body = req.body,\n' ..
        '        })\n' ..
        '    end,\n' ..
        '}\n'
end

local function tpl_button_component()
    return '-- app/components/Button.lx\n' ..
        '-- Componente reutilizÃ¡vel\n\n' ..
        'local Button_ = html.button  -- Alias para DaviLuaXML\n\n' ..
        'local Button = component(function(props, children)\n' ..
        '    local class = props.class or "btn"\n' ..
        '    return <Button_ class={class}>\n' ..
        '        {children}\n' ..
        '    </Button_>\n' ..
        'end)\n\n' ..
        'return Button\n'
end

local function tpl_css(name)
    return '/* ' .. name .. ' - Estilos */\n\n' ..
        '* { margin: 0; padding: 0; box-sizing: border-box; }\n\n' ..
        'body {\n' ..
        '    font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;\n' ..
        '    line-height: 1.6;\n' ..
        '    color: #333;\n' ..
        '    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);\n' ..
        '    min-height: 100vh;\n' ..
        '    display: flex;\n' ..
        '    align-items: center;\n' ..
        '    justify-content: center;\n' ..
        '}\n\n' ..
        '.container {\n' ..
        '    background: white;\n' ..
        '    padding: 3rem;\n' ..
        '    border-radius: 1rem;\n' ..
        '    box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);\n' ..
        '    text-align: center;\n' ..
        '    max-width: 500px;\n' ..
        '}\n\n' ..
        'h1 { color: #764ba2; margin-bottom: 1rem; font-size: 2rem; }\n' ..
        'p { color: #666; margin-bottom: 1.5rem; }\n'
end

local function tpl_gitignore()
    return '*.luac\nlua_modules/\n*.log\n.DS_Store\n.vscode/\n*.swp\n'
end

local function tpl_readme(name)
    return '# ' .. name .. '\n\n' ..
        'Projeto criado com [PudimWeb](https://github.com/pessoa736/PudimWeb) ğŸ®\n\n' ..
        '## Estrutura (estilo Next.js)\n\n' ..
        '```\n' ..
        name .. '/\n' ..
        'â”œâ”€â”€ server.lua        # Ponto de entrada\n' ..
        'â”œâ”€â”€ app/\n' ..
        'â”‚   â”œâ”€â”€ pages/        # Rotas automÃ¡ticas\n' ..
        'â”‚   â”‚   â”œâ”€â”€ index.lx  # â†’ /\n' ..
        'â”‚   â”‚   â””â”€â”€ about.lx  # â†’ /about\n' ..
        'â”‚   â”œâ”€â”€ api/          # API Routes\n' ..
        'â”‚   â”‚   â””â”€â”€ hello.lua # â†’ /api/hello\n' ..
        'â”‚   â”œâ”€â”€ components/   # Componentes\n' ..
        'â”‚   â””â”€â”€ public/       # Arquivos estÃ¡ticos\n' ..
        'â””â”€â”€ lua_modules/      # DependÃªncias\n' ..
        '```\n\n' ..
        '## InstalaÃ§Ã£o\n\n' ..
        '```bash\n./install.sh\n```\n\n' ..
        '## Executar\n\n' ..
        '```bash\nlua server.lua\n```\n\n' ..
        'Acesse: http://localhost:3000\n'
end

local function tpl_install()
    return '#!/bin/bash\n' ..
        'echo "ğŸ® Instalando dependÃªncias..."\n' ..
        'echo ""\n' ..
        '# Instala PudimWeb do GitHub (ainda nÃ£o estÃ¡ no luarocks.org)\n' ..
        'if [ ! -d "/tmp/PudimWeb" ]; then\n' ..
        '    git clone --depth 1 https://github.com/pessoa736/PudimWeb.git /tmp/PudimWeb\n' ..
        'fi\n' ..
        'cd /tmp/PudimWeb && luarocks make --tree "$OLDPWD/lua_modules" rockspecs/pudimweb-dev-2.rockspec\n' ..
        'cd "$OLDPWD"\n' ..
        'echo ""\n' ..
        'echo "âœ“ Pronto! Execute: lua server.lua"\n'
end

function CLI.new(project_name)
    if not project_name or project_name == "" then
        print_error("Nome do projeto Ã© obrigatÃ³rio!")
        print_info("Uso: pudim new <nome-do-projeto>")
        return false
    end
    
    if project_name:match("[^%w_-]") then
        print_error("Nome invÃ¡lido. Use apenas letras, nÃºmeros, _ e -")
        return false
    end
    
    print_logo()
    print_info("Criando projeto: " .. colorize(project_name, "bold"))
    print_info("Estrutura: Next.js style ğŸš€")
    print("")
    
    -- Estrutura de diretÃ³rios estilo Next.js
    local dirs = {
        project_name,
        project_name .. "/app",
        project_name .. "/app/pages",
        project_name .. "/app/api",
        project_name .. "/app/components",
        project_name .. "/app/public",
        project_name .. "/app/public/css",
        project_name .. "/app/public/js",
        project_name .. "/app/public/images",
    }
    
    for _, dir in ipairs(dirs) do
        mkdir(dir)
        print_success("Criado: " .. dir .. "/")
    end
    
    local files = {
        ["server.lua"] = tpl_server(project_name),
        ["app/pages/index.lx"] = tpl_index(project_name),
        ["app/pages/about.lx"] = tpl_about(project_name),
        ["app/api/hello.lua"] = tpl_api_hello(),
        ["app/components/Button.lx"] = tpl_button_component(),
        ["app/public/css/style.css"] = tpl_css(project_name),
        [".gitignore"] = tpl_gitignore(),
        ["README.md"] = tpl_readme(project_name),
        ["install.sh"] = tpl_install(),
    }
    
    for filename, content in pairs(files) do
        local filepath = project_name .. "/" .. filename
        if write_file(filepath, content) then
            print_success("Criado: " .. filename)
        else
            print_error("Erro ao criar: " .. filename)
        end
    end
    
    os.execute('chmod +x "' .. project_name .. '/install.sh"')
    
    print("")
    print(colorize("  âœ¨ Projeto criado com sucesso!", "green"))
    print("")
    print_info("Estrutura criada:")
    print("    ğŸ“ app/pages/     â†’ Rotas automÃ¡ticas")
    print("    ğŸ“ app/api/       â†’ API Routes")  
    print("    ğŸ“ app/components â†’ Componentes")
    print("    ğŸ“ app/public/    â†’ Arquivos estÃ¡ticos")
    print("")
    print_info("PrÃ³ximos passos:")
    print("")
    print("    " .. colorize("cd " .. project_name, "cyan"))
    print("    " .. colorize("./install.sh", "cyan"))
    print("    " .. colorize("lua server.lua", "cyan"))
    print("")
    print_info("Acesse: " .. colorize("http://localhost:3000", "bold"))
    print("")
    
    return true
end

function CLI.serve(port)
    port = port or 9001
    print_logo()
    print_info("Iniciando servidor na porta " .. port .. "...")
    os.execute("lua server.lua")
end

function CLI.help()
    print_logo()
    print([[
  ]] .. colorize("COMANDOS:", "bold") .. [[

    ]] .. colorize("pudim new <nome>", "cyan") .. [[      Cria um novo projeto
    ]] .. colorize("pudim serve", "cyan") .. [[           Inicia o servidor
    ]] .. colorize("pudim help", "cyan") .. [[            Mostra esta ajuda

  ]] .. colorize("EXEMPLOS:", "bold") .. [[

    pudim new meu-site
    pudim new blog

  ]] .. colorize("MAIS INFO:", "bold") .. [[

    https://github.com/pessoa736/PudimWeb

]])
end

local function main(args)
    local cmd = args[1]
    
    if not cmd or cmd == "help" or cmd == "-h" or cmd == "--help" then
        CLI.help()
    elseif cmd == "new" then
        CLI.new(args[2])
    elseif cmd == "serve" then
        CLI.serve(args[2])
    else
        print_error("Comando desconhecido: " .. cmd)
        print_info("Use 'pudim help' para ver os comandos")
    end
end

main(arg or {})
return CLI
