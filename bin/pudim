#!/usr/bin/env lua
--[[
    PudimWeb CLI - Create and manage PudimWeb projects
    
    Commands:
        new <name>      Create a new project
        serve [port]    Start development server  
        build           Build for production
        clean           Clean build artifacts
        version         Show version
        help            Show help
]]

local VERSION = "1.0-2"

-- Colors (ANSI)
local colors = {
    reset = "\27[0m",
    bold = "\27[1m",
    red = "\27[31m",
    green = "\27[32m",
    yellow = "\27[33m",
    blue = "\27[34m",
    cyan = "\27[36m",
    gray = "\27[90m"
}

local function color(c, text)
    return colors[c] .. text .. colors.reset
end

local function log(...)
    print(color("cyan", "[pudim]"), ...)
end

local function success(...)
    print(color("green", "âœ“"), ...)
end

local function warn(...)
    print(color("yellow", "âš "), ...)
end

local function err(...)
    print(color("red", "âœ—"), ...)
end

-- File utilities
local function mkdir(path)
    os.execute('mkdir -p "' .. path .. '"')
end

local function writeFile(path, content)
    local file = io.open(path, "w")
    if file then
        file:write(content)
        file:close()
        return true
    end
    return false
end

local function fileExists(path)
    local file = io.open(path, "r")
    if file then
        file:close()
        return true
    end
    return false
end

-- ==============================================================
-- PROJECT TEMPLATES
-- ==============================================================

local templates = {}

-- server.lua - Main entry point
templates["server.lua"] = [[
-- Server configuration for PudimWeb
require("DaviLuaXML")
local pudim = require("PudimWeb")

-- Expose PudimWeb globals (component, html, etc.)
pudim.expose()

-- Start the server
pudim.start({
    port = 3000,
    host = "127.0.0.1",
    pagesDir = "./app/pages",
    publicDir = "./app/public",
    apiDir = "./app/api",
    componentsDir = "./app/components"
})
]]

-- app/layout.lx - Global layout
templates["app/layout.lx"] = [[
-- Global Layout Component
-- This wraps all pages automatically

local Html, Head, Body = html.html, html.head, html.body
local Title, Meta, Link = html.title, html.meta, html.link
local Script = html.script

return component(function(props, children)
    local pageTitle = props.title or "PudimWeb App"
    
    return Html({ lang = "pt-BR" },
        Head({},
            Meta({ charset = "UTF-8" }) ..
            Meta({ name = "viewport", content = "width=device-width, initial-scale=1.0" }) ..
            Title({}, pageTitle) ..
            Link({ rel = "stylesheet", href = "/styles.css" })
        ) ..
        Body({},
            children ..
            Script({ src = "/app.js" })
        )
    )
end)
]]

-- app/pages/index.lx - Home page
templates["app/pages/index.lx"] = [[
-- Home Page
-- Route: /

local Div, H1, P, A = html.div, html.h1, html.p, html.a
local Button, Ul, Li = html.button, html.ul, html.li
local Span, Header, Section = html.span, html.header, html.section

-- Interactive counter component
local Counter = component(function(props)
    local startValue = props.start or 0
    
    local onClick = client.function_("counterBtn", function()
        client.let("count", client.call("parseInt", 
            client.get("document.getElementById('count').textContent")
        ))
        client.set("count", client.op("count", "+", 1))
        client.set("document.getElementById('count').textContent", "count")
    end)
    
    return Div({ class = "counter" },
        P({}, "Contagem: " .. Span({ id = "count" }, tostring(startValue))) ..
        Button({ id = "counterBtn", onclick = "counterBtn()" }, "Incrementar") ..
        onClick
    )
end)

-- Feature list component
local FeatureList = component(function()
    return Ul({},
        Li({}, "ğŸ“ File-based routing (como Next.js)") ..
        Li({}, "ğŸ§© Componentes reutilizÃ¡veis") ..
        Li({}, "ğŸ¨ Sintaxe XML com DaviLuaXML") ..
        Li({}, "âš¡ Virtual DOM com tree diffing") ..
        Li({}, "ğŸ”„ Reconciler para atualizaÃ§Ãµes eficientes") ..
        Li({}, "ğŸŒ Client module para interatividade")
    )
end)

-- Page component
return component(function(props)
    local hero = Header({ class = "hero" },
        H1({}, "ğŸ® Bem-vindo ao PudimWeb!") ..
        P({ class = "subtitle" }, "Um framework web moderno para Lua, inspirado em React e Next.js")
    )
    
    local features = Section({ class = "features" },
        H1({}, "âœ¨ Features") .. FeatureList({})
    )
    
    local demo = Section({ class = "demo" },
        H1({}, "ğŸ¯ Exemplo Interativo") .. Counter({ start = 0 })
    )
    
    local links = Section({ class = "links" },
        H1({}, "ğŸ“š NavegaÃ§Ã£o") ..
        Div({ class = "nav-links" },
            A({ href = "/about", class = "link" }, "Sobre") ..
            A({ href = "/docs", class = "link" }, "DocumentaÃ§Ã£o") ..
            A({ href = "/api/hello", class = "link" }, "API Demo")
        )
    )
    
    return Div({ class = "container" }, hero .. features .. demo .. links)
end)
]]

-- app/pages/about.lx - About page
templates["app/pages/about.lx"] = [[
-- About Page
-- Route: /about

local Div, H1, H2, P, A = html.div, html.h1, html.h2, html.p, html.a
local Code, Pre = html.code, html.pre
local Section, Strong = html.section, html.strong

-- Code example as string
local codeExample = "local Card = component(function(props, children)\n" ..
    "    return Div({ class = 'card' },\n" ..
    "        H2({}, props.title) .. children\n" ..
    "    )\n" ..
    "end)\n\n" ..
    "-- Usando:\n" ..
    "Card({ title = 'Meu Card' }, P({}, 'Conteudo do card'))"

return component(function(props)
    local sections = 
        Section({},
            H2({}, "O que e?") ..
            P({}, "PudimWeb e um framework web para Lua 5.4 que traz conceitos modernos de desenvolvimento web para o ecossistema Lua.")
        ) ..
        Section({},
            H2({}, "Stack Tecnologica") ..
            P({}, Strong({}, "Lua 5.4") .. " - Linguagem de programacao") ..
            P({}, Strong({}, "DaviLuaXML") .. " - Sintaxe XML em Lua") ..
            P({}, Strong({}, "LuaSocket") .. " - Servidor HTTP") ..
            P({}, Strong({}, "loglua") .. " - Sistema de logging")
        ) ..
        Section({},
            H2({}, "Exemplo de Componente") ..
            Pre({}, Code({}, codeExample))
        )
    
    return Div({ class = "container" },
        H1({}, "Sobre o PudimWeb") ..
        sections ..
        A({ href = "/", class = "link" }, "Voltar para Home")
    )
end)
]]

-- app/pages/docs.lx - Documentation page
templates["app/pages/docs.lx"] = [[
-- Documentation Page
-- Route: /docs

local Div, H1, H2, H3, P, A = html.div, html.h1, html.h2, html.h3, html.p, html.a
local Pre, Code, Ul, Li = html.pre, html.code, html.ul, html.li
local Nav, Section = html.nav, html.section

-- Code examples
local componentCode = "local Button = component(function(props, children)\n" ..
    "    local class = props.class or 'btn'\n" ..
    "    return html.button({ class = class }, children)\n" ..
    "end)"

local routingCode = "app/pages/\n" ..
    "  index.lx      -> /\n" ..
    "  about.lx      -> /about\n" ..
    "  blog/\n" ..
    "    index.lx  -> /blog\n" ..
    "    [id].lx   -> /blog/:id"

local clientCode = "local onClick = client.function_('handleClick', function()\n" ..
    "    client.call('alert', 'Ola!')\n" ..
    "end)\n" ..
    "-- Gera: function handleClick(){alert('Ola!')}"

local vdomCode = "local vdom = require('PudimWeb.core.vdom')\n" ..
    "local tree = vdom.h('div', {class='box'}, {\n" ..
    "    vdom.h('p', {}, 'Texto')\n" ..
    "})"

return component(function(props)
    local toc = Nav({ class = "toc" },
        H3({}, "Indice") ..
        Ul({},
            Li({}, A({ href = "#components" }, "Componentes")) ..
            Li({}, A({ href = "#routing" }, "Roteamento")) ..
            Li({}, A({ href = "#client" }, "Client Module")) ..
            Li({}, A({ href = "#vdom" }, "Virtual DOM"))
        )
    )
    
    local sections = 
        Section({ id = "components" },
            H2({}, "Componentes") ..
            P({}, "Componentes sao funcoes que recebem props e children:") ..
            Pre({}, Code({}, componentCode))
        ) ..
        Section({ id = "routing" },
            H2({}, "Roteamento") ..
            P({}, "O roteamento e baseado em arquivos (File-based routing):") ..
            Pre({}, Code({}, routingCode))
        ) ..
        Section({ id = "client" },
            H2({}, "Client Module") ..
            P({}, "O modulo client gera JavaScript a partir de Lua:") ..
            Pre({}, Code({}, clientCode))
        ) ..
        Section({ id = "vdom" },
            H2({}, "Virtual DOM") ..
            P({}, "O VDom otimiza atualizacoes comparando arvores:") ..
            Pre({}, Code({}, vdomCode))
        )
    
    return Div({ class = "container docs" },
        H1({}, "Documentacao") ..
        toc ..
        sections ..
        A({ href = "/", class = "link" }, "Voltar para Home")
    )
end)
]]

-- app/pages/blog/index.lx - Blog listing
templates["app/pages/blog/index.lx"] = [[
-- Blog Index Page
-- Route: /blog

local Div, H1, H2, P, A = html.div, html.h1, html.h2, html.p, html.a

-- Mock posts (in production, load from DB or API)
local posts = {
    { id = "1", title = "Introducao ao PudimWeb", date = "2025-01-15" },
    { id = "2", title = "Componentes Reutilizaveis", date = "2025-01-10" },
    { id = "3", title = "Virtual DOM Explicado", date = "2025-01-05" }
}

local PostCard = component(function(props)
    return Div({ class = "post-card" },
        H2({}, A({ href = "/blog/" .. props.id }, props.title)) ..
        P({ class = "date" }, props.date)
    )
end)

return component(function(props)
    local postList = {}
    for _, post in ipairs(posts) do
        table.insert(postList, PostCard({ id = post.id, title = post.title, date = post.date }))
    end
    
    return Div({ class = "container" },
        H1({}, "ğŸ“ Blog") ..
        P({}, "Ultimos artigos sobre PudimWeb") ..
        Div({ class = "posts" }, table.concat(postList)) ..
        A({ href = "/", class = "link" }, "â† Voltar para Home")
    )
end)
]]

-- app/pages/blog/[id].lx - Dynamic blog post page
templates["app/pages/blog/[id].lx"] = [[
-- Blog Post Page (Dynamic Route)
-- Route: /blog/:id

local Div, H1, P, A = html.div, html.h1, html.p, html.a
local Article = html.article

-- Mock database
local postsDB = {
    ["1"] = {
        title = "Introducao ao PudimWeb",
        content = "PudimWeb e um framework web moderno para Lua...",
        date = "2025-01-15"
    },
    ["2"] = {
        title = "Componentes Reutilizaveis",
        content = "Aprenda a criar componentes que podem ser usados em todo o projeto...",
        date = "2025-01-10"
    },
    ["3"] = {
        title = "Virtual DOM Explicado",
        content = "Entenda como o Virtual DOM otimiza a renderizacao...",
        date = "2025-01-05"
    }
}

return component(function(props)
    local id = props.params and props.params.id or "1"
    local post = postsDB[id]
    
    if not post then
        return Div({ class = "container" },
            H1({}, "404 - Post nao encontrado") ..
            A({ href = "/blog", class = "link" }, "â† Voltar para Blog")
        )
    end
    
    return Div({ class = "container" },
        A({ href = "/blog", class = "link" }, "â† Voltar para Blog") ..
        Article({},
            H1({}, post.title) ..
            P({ class = "date" }, "Publicado em: " .. post.date) ..
            P({ class = "content" }, post.content)
        )
    )
end)
]]

-- app/api/hello.lua - API endpoint
templates["app/api/hello.lua"] = [[
-- API Route: /api/hello
-- Returns JSON data

local json = require("PudimWeb.utils.json")

return {
    -- GET /api/hello
    GET = function(req, res)
        res:json({
            message = "Ola do PudimWeb!",
            timestamp = os.time(),
            method = "GET"
        })
    end,
    
    -- POST /api/hello
    POST = function(req, res)
        local body = req.body or {}
        res:json({
            message = "Dados recebidos!",
            received = body,
            method = "POST"
        })
    end
}
]]

-- app/api/users.lua - Users API example
templates["app/api/users.lua"] = [[
-- API Route: /api/users
-- RESTful users endpoint

local json = require("PudimWeb.utils.json")

-- Mock database
local users = {
    { id = 1, name = "Alice", email = "alice@email.com" },
    { id = 2, name = "Bob", email = "bob@email.com" },
    { id = 3, name = "Carol", email = "carol@email.com" }
}

return {
    -- GET /api/users - List all users
    GET = function(req, res)
        res:json({
            users = users,
            count = #users
        })
    end,
    
    -- POST /api/users - Create user
    POST = function(req, res)
        local body = req.body or {}
        
        if not body.name or not body.email then
            res:status(400):json({
                error = "name and email are required"
            })
            return
        end
        
        local newUser = {
            id = #users + 1,
            name = body.name,
            email = body.email
        }
        table.insert(users, newUser)
        
        res:status(201):json({
            message = "User created",
            user = newUser
        })
    end
}
]]

-- app/components/Button.lx - Reusable button component
templates["app/components/Button.lx"] = [[
-- Reusable Button Component

local ButtonEl = html.button

return component(function(props, children)
    local class = "btn"
    if props.variant == "primary" then
        class = class .. " btn-primary"
    elseif props.variant == "secondary" then
        class = class .. " btn-secondary"
    end
    
    if props.size == "large" then
        class = class .. " btn-lg"
    elseif props.size == "small" then
        class = class .. " btn-sm"
    end
    
    return ButtonEl({
        class = class,
        onclick = props.onclick,
        disabled = props.disabled
    }, children)
end)
]]

-- app/components/Card.lx - Card component
templates["app/components/Card.lx"] = [[
-- Card Component

local Div, H2 = html.div, html.h2

return component(function(props, children)
    local class = "card"
    if props.class then
        class = class .. " " .. props.class
    end
    
    local title = ""
    if props.title then
        title = H2({ class = "card-title" }, props.title)
    end
    
    return Div({ class = class },
        title ..
        Div({ class = "card-body" }, children)
    )
end)
]]

-- app/public/styles.css - Main stylesheet
templates["app/public/styles.css"] = [[
/* PudimWeb Default Styles */

:root {
    --primary: #8B5CF6;
    --primary-dark: #7C3AED;
    --secondary: #EC4899;
    --bg: #0F172A;
    --bg-light: #1E293B;
    --text: #F1F5F9;
    --text-muted: #94A3B8;
    --border: #334155;
    --success: #10B981;
    --error: #EF4444;
}

* {
    box-sizing: border-box;
    margin: 0;
    padding: 0;
}

body {
    font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
    background: var(--bg);
    color: var(--text);
    line-height: 1.6;
    min-height: 100vh;
}

.container {
    max-width: 900px;
    margin: 0 auto;
    padding: 2rem;
}

/* Hero Section */
.hero {
    text-align: center;
    padding: 3rem 0;
    border-bottom: 1px solid var(--border);
    margin-bottom: 2rem;
}

.hero h1 {
    font-size: 2.5rem;
    margin-bottom: 1rem;
    background: linear-gradient(135deg, var(--primary), var(--secondary));
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    background-clip: text;
}

.subtitle {
    color: var(--text-muted);
    font-size: 1.2rem;
}

/* Sections */
section {
    margin: 2rem 0;
    padding: 1.5rem;
    background: var(--bg-light);
    border-radius: 12px;
    border: 1px solid var(--border);
}

section h1 {
    font-size: 1.5rem;
    margin-bottom: 1rem;
    color: var(--primary);
}

/* Lists */
ul {
    list-style: none;
    padding-left: 0;
}

li {
    padding: 0.5rem 0;
    border-bottom: 1px solid var(--border);
}

li:last-child {
    border-bottom: none;
}

/* Links */
a {
    color: var(--primary);
    text-decoration: none;
    transition: color 0.2s;
}

a:hover {
    color: var(--secondary);
}

.link {
    display: inline-block;
    padding: 0.5rem 1rem;
    background: var(--bg-light);
    border: 1px solid var(--border);
    border-radius: 8px;
    margin: 0.25rem;
}

.link:hover {
    background: var(--primary);
    color: white;
    border-color: var(--primary);
}

.nav-links {
    display: flex;
    flex-wrap: wrap;
    gap: 0.5rem;
}

/* Buttons */
.btn {
    padding: 0.75rem 1.5rem;
    border: none;
    border-radius: 8px;
    cursor: pointer;
    font-size: 1rem;
    font-weight: 500;
    transition: all 0.2s;
    background: var(--primary);
    color: white;
}

.btn:hover {
    background: var(--primary-dark);
    transform: translateY(-2px);
}

.btn-secondary {
    background: var(--bg-light);
    border: 1px solid var(--border);
    color: var(--text);
}

.btn-secondary:hover {
    background: var(--border);
}

.btn-lg {
    padding: 1rem 2rem;
    font-size: 1.1rem;
}

.btn-sm {
    padding: 0.5rem 1rem;
    font-size: 0.9rem;
}

/* Counter Demo */
.counter {
    text-align: center;
    padding: 1rem;
}

.counter p {
    font-size: 1.5rem;
    margin-bottom: 1rem;
}

.counter #count {
    font-weight: bold;
    color: var(--secondary);
    font-size: 2rem;
}

/* Cards */
.card {
    background: var(--bg-light);
    border: 1px solid var(--border);
    border-radius: 12px;
    padding: 1.5rem;
    margin: 1rem 0;
}

.card-title {
    margin-bottom: 1rem;
    color: var(--primary);
}

/* Post Cards */
.post-card {
    padding: 1rem;
    margin: 1rem 0;
    background: var(--bg);
    border-radius: 8px;
}

.post-card h2 {
    font-size: 1.2rem;
}

.date {
    color: var(--text-muted);
    font-size: 0.9rem;
}

/* Code */
pre {
    background: var(--bg);
    border: 1px solid var(--border);
    border-radius: 8px;
    padding: 1rem;
    overflow-x: auto;
    margin: 1rem 0;
}

code {
    font-family: 'Fira Code', 'Monaco', monospace;
    font-size: 0.9rem;
    color: var(--secondary);
}

/* Documentation */
.docs .toc {
    background: var(--bg);
    padding: 1rem;
    border-radius: 8px;
    margin-bottom: 2rem;
}

.docs .toc h3 {
    margin-bottom: 0.5rem;
}

.docs section {
    margin: 2rem 0;
}

/* Responsive */
@media (max-width: 768px) {
    .container {
        padding: 1rem;
    }
    
    .hero h1 {
        font-size: 1.8rem;
    }
    
    .nav-links {
        flex-direction: column;
    }
}
]]

-- app/public/app.js - Client-side JavaScript
templates["app/public/app.js"] = [[
// PudimWeb Client-side JavaScript

console.log('ğŸ® PudimWeb app loaded!');

// Smooth scroll for anchor links
document.querySelectorAll('a[href^="#"]').forEach(anchor => {
    anchor.addEventListener('click', function (e) {
        e.preventDefault();
        document.querySelector(this.getAttribute('href')).scrollIntoView({
            behavior: 'smooth'
        });
    });
});

// Add loaded class for animations
document.addEventListener('DOMContentLoaded', () => {
    document.body.classList.add('loaded');
});
]]

-- .gitignore
templates[".gitignore"] = [[
# Dependencies
lua_modules/
.luarocks/

# Build
dist/
build/

# Logs
*.log
log.txt

# IDE
.vscode/
.idea/

# OS
.DS_Store
Thumbs.db
]]

-- README.md
templates["README.md"] = [[
# ğŸ® Meu Projeto PudimWeb

Projeto criado com [PudimWeb](https://github.com/yourusername/PudimWeb).

## ğŸ“ Estrutura

```
â”œâ”€â”€ server.lua           # Entry point
â”œâ”€â”€ app/
â”‚   â”œâ”€â”€ layout.lx        # Global layout
â”‚   â”œâ”€â”€ pages/           # File-based routing
â”‚   â”‚   â”œâ”€â”€ index.lx     # /
â”‚   â”‚   â”œâ”€â”€ about.lx     # /about
â”‚   â”‚   â”œâ”€â”€ docs.lx      # /docs
â”‚   â”‚   â””â”€â”€ blog/
â”‚   â”‚       â”œâ”€â”€ index.lx # /blog
â”‚   â”‚       â””â”€â”€ [id].lx  # /blog/:id
â”‚   â”œâ”€â”€ api/             # API routes
â”‚   â”‚   â”œâ”€â”€ hello.lua    # /api/hello
â”‚   â”‚   â””â”€â”€ users.lua    # /api/users
â”‚   â”œâ”€â”€ components/      # Reusable components
â”‚   â””â”€â”€ public/          # Static files
```

## ğŸš€ ComeÃ§ando

```bash
# Iniciar servidor de desenvolvimento
lua server.lua

# Ou usando o CLI
pudim serve
```

O servidor estarÃ¡ disponÃ­vel em `http://localhost:3000`.

## ğŸ“– DocumentaÃ§Ã£o

Visite `/docs` no app para ver a documentaÃ§Ã£o integrada.

## ğŸ› ï¸ Comandos

```bash
pudim serve [port]  # Iniciar servidor
pudim build         # Build para produÃ§Ã£o
pudim clean         # Limpar arquivos de build
```

## ğŸ“ LicenÃ§a

MIT
]]

-- ==============================================================
-- CLI COMMANDS
-- ==============================================================

local function showHelp()
    print([[
ğŸ® ]] .. color("bold", "PudimWeb CLI") .. [[ v]] .. VERSION .. [[


]] .. color("yellow", "USAGE:") .. [[
    pudim <command> [options]

]] .. color("yellow", "COMMANDS:") .. [[
    ]] .. color("green", "new <name>") .. [[      Create a new PudimWeb project
    ]] .. color("green", "serve [port]") .. [[    Start development server (default: 3000)
    ]] .. color("green", "build") .. [[           Build project for production
    ]] .. color("green", "clean") .. [[           Remove build artifacts
    ]] .. color("green", "version") .. [[         Show version
    ]] .. color("green", "help") .. [[            Show this help

]] .. color("yellow", "EXAMPLES:") .. [[
    pudim new meu-app       Create project 'meu-app'
    pudim serve             Start server on port 3000
    pudim serve 8080        Start server on port 8080
    pudim build             Create production build

]] .. color("yellow", "DOCS:") .. [[
    https://github.com/yourusername/PudimWeb
]])
end

local function showVersion()
    print(color("cyan", "PudimWeb") .. " v" .. VERSION)
end

local function createProject(name)
    if not name then
        err("Project name is required")
        print("Usage: pudim new <project-name>")
        return
    end
    
    -- Validate name
    if name:match("[^%w%-_]") then
        err("Project name can only contain letters, numbers, hyphens and underscores")
        return
    end
    
    -- Check if exists
    local check = io.open(name .. "/server.lua", "r")
    if check then
        check:close()
        err("Directory '" .. name .. "' already contains a project")
        return
    end
    
    print()
    log("Creating project: " .. color("bold", name))
    print()
    
    -- Create directories
    local dirs = {
        name,
        name .. "/app",
        name .. "/app/pages",
        name .. "/app/pages/blog",
        name .. "/app/api",
        name .. "/app/components",
        name .. "/app/public"
    }
    
    for _, dir in ipairs(dirs) do
        mkdir(dir)
    end
    success("Created directories")
    
    -- Create files
    local files = {
        { path = "server.lua", template = "server.lua" },
        { path = "app/layout.lx", template = "app/layout.lx" },
        { path = "app/pages/index.lx", template = "app/pages/index.lx" },
        { path = "app/pages/about.lx", template = "app/pages/about.lx" },
        { path = "app/pages/docs.lx", template = "app/pages/docs.lx" },
        { path = "app/pages/blog/index.lx", template = "app/pages/blog/index.lx" },
        { path = "app/pages/blog/[id].lx", template = "app/pages/blog/[id].lx" },
        { path = "app/api/hello.lua", template = "app/api/hello.lua" },
        { path = "app/api/users.lua", template = "app/api/users.lua" },
        { path = "app/components/Button.lx", template = "app/components/Button.lx" },
        { path = "app/components/Card.lx", template = "app/components/Card.lx" },
        { path = "app/public/styles.css", template = "app/public/styles.css" },
        { path = "app/public/app.js", template = "app/public/app.js" },
        { path = ".gitignore", template = ".gitignore" },
        { path = "README.md", template = "README.md" }
    }
    
    for _, file in ipairs(files) do
        local content = templates[file.template]
        if content then
            writeFile(name .. "/" .. file.path, content)
            print("  " .. color("gray", "â†’") .. " " .. file.path)
        end
    end
    success("Created " .. #files .. " files")
    
    print()
    print(color("green", "âœ¨ Project created successfully!"))
    print()
    print("Next steps:")
    print("  " .. color("cyan", "cd " .. name))
    print("  " .. color("cyan", "luarocks install pudimweb --local") .. color("gray", "  # install PudimWeb"))
    print("  " .. color("cyan", "pudim serve") .. color("gray", "                        # start server"))
    print()
end

local function serve(port)
    port = port or "3000"
    
    -- Check for server.lua
    if not fileExists("server.lua") then
        err("server.lua not found")
        print("Make sure you're in a PudimWeb project directory")
        return
    end
    
    log("Starting development server on port " .. color("bold", port))
    print()
    
    -- Run the server
    os.execute("lua server.lua " .. port)
end

local function build()
    -- Check for server.lua
    if not fileExists("server.lua") then
        err("server.lua not found")
        print("Make sure you're in a PudimWeb project directory")
        return
    end
    
    log("Building project for production...")
    
    -- Try to load PudimWeb builder
    local ok, pudim = pcall(require, "PudimWeb")
    if not ok then
        err("PudimWeb not found. Install it with: luarocks install pudimweb")
        return
    end
    
    if not pudim.builder then
        err("Builder module not available in this version")
        return
    end
    
    -- Run build
    local buildOk, result = pcall(pudim.builder.build, ".", "./dist")
    
    if buildOk and result and result.success then
        print()
        success("Build completed!")
        print("  Output: " .. color("cyan", "./dist"))
        if result.stats then
            print("  Files: " .. result.stats.totalFiles)
            print("  Size: " .. string.format("%.2f KB", (result.stats.totalSize or 0) / 1024))
        end
    else
        err("Build failed: " .. tostring(result and result.error or "unknown error"))
    end
end

local function clean()
    log("Cleaning build artifacts...")
    
    os.execute("rm -rf ./dist")
    os.execute("rm -rf ./build")
    os.execute("rm -rf ./.pudim-cache")
    
    success("Cleaned build directories")
end

-- ==============================================================
-- MAIN
-- ==============================================================

local command = arg[1]

if not command or command == "help" or command == "-h" or command == "--help" then
    showHelp()
elseif command == "version" or command == "-v" or command == "--version" then
    showVersion()
elseif command == "new" then
    createProject(arg[2])
elseif command == "serve" or command == "start" or command == "dev" then
    serve(arg[2])
elseif command == "build" then
    build()
elseif command == "clean" then
    clean()
else
    err("Unknown command: " .. command)
    print("Run 'pudim help' for usage information")
end
